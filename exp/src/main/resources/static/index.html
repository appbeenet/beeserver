<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>AppBee ‚Äì Oyunla≈ütƒ±rƒ±lmƒ±≈ü IT Platformu</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="border-b border-slate-800">
    <div class="max-w-5xl mx-auto flex items-center justify-between py-4 px-4">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-yellow-400 flex items-center justify-center text-slate-900 font-bold">
          üêù
        </div>
        <span class="font-semibold text-lg">AppBee XP Panel</span>
      </div>
      <div id="userInfo" class="text-sm text-slate-300 hidden">
        <span id="userEmail"></span>
        <button
          onclick="logout()"
          class="ml-4 text-xs px-3 py-1 rounded-full border border-slate-600 hover:bg-slate-800">
          √áƒ±kƒ±≈ü
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1">
    <div class="max-w-5xl mx-auto py-10 px-4 grid md:grid-cols-3 gap-6">

      <!-- Sol kolon: Auth + Sponsor -->
      <div class="md:col-span-1 space-y-6">

        <!-- Auth Card -->
        <section id="authCard" class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 shadow">
          <h2 class="text-lg font-semibold mb-4">Giri≈ü / Kayƒ±t</h2>

          <!-- Mode Tabs: Engineer vs Company -->
          <div class="flex text-xs mb-3 border border-slate-700 rounded-full p-1 bg-slate-950/60">
            <button
              id="modeEngineer"
              class="flex-1 py-1 rounded-full text-center font-medium bg-slate-800"
              type="button"
              onclick="switchAppMode('engineer')">
              Junior / Engineer
            </button>
            <button
              id="modeCompany"
              class="flex-1 py-1 rounded-full text-center font-medium text-slate-300"
              type="button"
              onclick="switchAppMode('company')">
              Firma
            </button>
          </div>

          <!-- Login/Register Tabs -->
          <div id="engineerModeTabs" class="flex text-xs mb-3 border border-slate-700 rounded-full p-1 bg-slate-950/60">
            <button
              id="tabLogin"
              class="flex-1 py-1 rounded-full text-center font-medium bg-slate-800"
              type="button"
              onclick="switchAuthMode('login')">
              Giri≈ü
            </button>
            <button
              id="tabRegister"
              class="flex-1 py-1 rounded-full text-center font-medium text-slate-300"
              type="button"
              onclick="switchAuthMode('register')">
              Kayƒ±t Ol
            </button>
          </div>

          <!-- Form -->
          <form id="authForm" class="space-y-3">
            <!-- ƒ∞sim Soyisim (register modunda) -->
            <div id="fullNameGroup" class="hidden">
              <label class="block text-sm mb-1" for="fullName">ƒ∞sim Soyisim</label>
              <input
                id="fullName"
                name="fullName"
                type="text"
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400"
                placeholder="√ñrn: Junior Engineer / Firma Yetkilisi"
              />
            </div>

            <!-- Email -->
            <div>
              <label class="block text-sm mb-1" for="email">E-posta</label>
              <input
                id="email"
                name="email"
                type="email"
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400"
                placeholder="junior@appbee.test / company@appbee.test"
                required
              />
            </div>

            <!-- Password -->
            <div>
              <label class="block text-sm mb-1" for="password">≈ûifre</label>
              <input
                id="password"
                name="password"
                type="password"
                class="w-full rounded-xl bg-slate-900 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400"
                placeholder="Password123"
                required
              />
            </div>

            <button
              id="authSubmitBtn"
              type="submit"
              class="w-full rounded-xl bg-yellow-400 text-slate-900 font-semibold py-2 text-sm hover:bg-yellow-300 transition">
              Giri≈ü Yap
            </button>

            <p id="authInfo" class="text-xs text-slate-400 mt-1">
              Hesabƒ±n yok mu? Kayƒ±t olmak i√ßin √ºstteki sekmeden <strong>Kayƒ±t Ol</strong>‚Äôu se√ß.
            </p>

            <p id="authError" class="text-xs text-red-400 mt-1 hidden"></p>
            <p id="registerSuccess" class="text-xs text-emerald-400 mt-1 hidden">
              Kayƒ±t ba≈üarƒ±lƒ±! ≈ûimdi giri≈ü yapabilirsiniz.
            </p>
          </form>
        </section>

        <!-- Sponsor Ol Card -->
        <section class="bg-slate-900/60 border border-yellow-500/60 rounded-2xl p-5 shadow">
          <h2 class="text-lg font-semibold mb-2">Sponsor Ol üêù</h2>
          <p class="text-sm text-slate-200 mb-3">
            AppBee, yeni mezun ve junior m√ºhendislerin ger√ßek projelerde deneyim kazanmasƒ±nƒ± saƒülayan oyunla≈ütƒ±rƒ±lmƒ±≈ü bir IT ekosistemi.
          </p>
          <ul class="text-xs text-slate-300 mb-3 space-y-1">
            <li>‚Ä¢ Ger√ßek projelerde katkƒ± veren gen√ß yetenekler</li>
            <li>‚Ä¢ ≈ûeffaf XP & g√∂rev takibi</li>
            <li>‚Ä¢ ≈ûirketiniz i√ßin yetenek havuzu ve g√∂r√ºn√ºrl√ºk</li>
          </ul>
          <a
            href="mailto:info@appbee.dev?subject=AppBee%20Sponsorluk"
            class="inline-flex items-center justify-center w-full rounded-xl border border-yellow-400 text-yellow-300 text-sm font-medium py-2 hover:bg-yellow-400 hover:text-slate-900 transition">
            Sponsorluk i√ßin ileti≈üime ge√ß
          </a>
        </section>

      </div>

      <!-- Saƒü kolon -->
      <div class="md:col-span-2 space-y-6">

        <!-- Engineer Panel: XP + Task List -->
        <div id="engineerPanel" class="space-y-6">
          <!-- XP √ñzet -->
          <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 shadow">
            <h2 class="text-lg font-semibold mb-3">XP Durumu</h2>
            <div class="flex items-center gap-6">
              <div>
                <p class="text-xs text-slate-400 mb-1">Toplam XP</p>
                <p id="totalXp" class="text-3xl font-bold text-yellow-400">0</p>
              </div>
              <div>
                <p class="text-xs text-slate-400 mb-1">Seviye</p>
                <p id="level" class="text-xl font-semibold">‚Äî</p>
              </div>
            </div>
          </section>

          <!-- G√∂rev Listesi (Engineer) -->
          <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 shadow">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-semibold">G√∂revler (G√∂revi Al & Submit)</h2>
              <span id="taskCount" class="text-xs text-slate-400">0 g√∂rev</span>
            </div>
            <div id="taskList" class="space-y-2 text-sm">
              <p class="text-slate-400 text-xs">
                Giri≈ü yaptƒ±ktan sonra a√ßƒ±k g√∂revler burada listelenecek.
                <br/>
                G√∂revi aldƒ±ƒüƒ±nda kart √ºzerinde <strong>Submit (√á√∂z√ºm G√∂nder)</strong> butonu a√ßƒ±lacak.
              </p>
            </div>
            <p id="taskError" class="text-xs text-red-400 mt-3 hidden"></p>
          </section>
        </div>

        <!-- Company Panel -->
        <section id="companyPanel" class="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 shadow hidden">
          <!-- Firma login DEƒûƒ∞LKEN g√∂r√ºnen tanƒ±tƒ±m alanƒ± -->
          <div id="companyInfo" class="space-y-3">
            <h2 class="text-lg font-semibold text-yellow-300">AppBee ile firmalar i√ßin akƒ±llƒ± g√∂rev platformu</h2>
            <p class="text-sm text-slate-200">
              AppBee, ger√ßek proje ihtiya√ßlarƒ±nƒ±zƒ± junior m√ºhendislerle bulu≈üturan, ≈üeffaf ve oyunla≈ütƒ±rƒ±lmƒ±≈ü bir g√∂rev platformudur.
            </p>
            <ul class="space-y-2 text-sm text-slate-300">
              <li>‚Ä¢ ƒ∞htiyaca g√∂re g√∂rev tanƒ±mlayƒ±p doƒüru yeteneklere ula≈üma</li>
              <li>‚Ä¢ XP ve g√∂rev puanƒ± ile ≈üeffaf performans takibi</li>
              <li>‚Ä¢ Esnek, proje bazlƒ± √ßalƒ±≈üma modeliyle maliyet optimizasyonu</li>
              <li>‚Ä¢ AppBee ekosisteminde firma g√∂r√ºn√ºrl√ºƒü√º ve i≈üveren markasƒ±</li>
            </ul>
            <p class="text-xs text-slate-400">
              Firma hesabƒ±nƒ±zla giri≈ü yaptƒ±ƒüƒ±nƒ±zda bu panelden junior m√ºhendisler i√ßin g√∂rev olu≈üturabilirsiniz.
            </p>
          </div>

          <!-- Firma login OLDUKTAN SONRA a√ßƒ±lan g√∂rev olu≈üturma formu -->
          <form id="taskCreateForm" class="space-y-3 hidden">
            <h2 class="text-lg font-semibold mb-3">Firma G√∂rev Y√∂netimi</h2>

            <div>
              <label class="block text-sm mb-1" for="taskTitle">G√∂rev Ba≈ülƒ±ƒüƒ±</label>
              <input
                id="taskTitle"
                type="text"
                class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400"
                placeholder="Design VLAN layout for branch office"
                required
              />
            </div>

            <div>
              <label class="block text-sm mb-1" for="taskDescription">A√ßƒ±klama</label>
              <textarea
                id="taskDescription"
                class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400"
                rows="3"
                placeholder="Prepare L2/L3 design, subnet plan and failover scenario."
              ></textarea>
            </div>

            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm mb-1" for="taskDifficulty">Zorluk</label>
                <select
                  id="taskDifficulty"
                  class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400">
                  <option value="EASY">EASY</option>
                  <option value="MEDIUM" selected>MEDIUM</option>
                  <option value="HARD">HARD</option>
                </select>
              </div>
              <div>
                <label class="block text-sm mb-1" for="taskPrice">√ñd√ºl (Price)</label>
                <input
                  id="taskPrice"
                  type="number"
                  min="0"
                  step="1"
                  class="w-full rounded-xl bg-slate-950 border border-slate-700 px-3 py-2 text-sm focus:outline-none focus:border-yellow-400"
                  placeholder="50"
                  required
                />
              </div>
            </div>

            <button
              type="submit"
              class="rounded-xl bg-yellow-400 text-slate-900 font-semibold px-4 py-2 text-sm hover:bg-yellow-300 transition">
              G√∂rev Olu≈ütur
            </button>

            <p id="taskCreateMsg" class="text-xs mt-2 hidden"></p>
          </form>
        </section>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-slate-800 py-4 text-center text-xs text-slate-500">
    AppBee ‚Ä¢ Kolektif √ñƒürenme & Deneyim Ekonomisi Platformu
  </footer>

  <!-- JS -->
  <script>
    // Backend aynƒ± host/port'taysa bo≈ü bƒ±rak
    const API_BASE = "";

    let authToken = null;
    let currentUser = null;
    let authMode = "login";      // "login" | "register"
    let appMode = "engineer";    // "engineer" | "company"

    const userInfo = document.getElementById("userInfo");
    const userEmail = document.getElementById("userEmail");
    const totalXp = document.getElementById("totalXp");
    const level = document.getElementById("level");
    const taskList = document.getElementById("taskList");
    const taskCount = document.getElementById("taskCount");
    const taskError = document.getElementById("taskError");

    const authForm = document.getElementById("authForm");
    const authError = document.getElementById("authError");
    const authInfo = document.getElementById("authInfo");
    const registerSuccess = document.getElementById("registerSuccess");
    const fullNameGroup = document.getElementById("fullNameGroup");
    const authSubmitBtn = document.getElementById("authSubmitBtn");
    const tabLogin = document.getElementById("tabLogin");
    const tabRegister = document.getElementById("tabRegister");
    const authCard = document.getElementById("authCard");
    const engineerModeTabs = document.getElementById("engineerModeTabs");
    const modeEngineer = document.getElementById("modeEngineer");
    const modeCompany = document.getElementById("modeCompany");

    const engineerPanel = document.getElementById("engineerPanel");
    const companyPanel = document.getElementById("companyPanel");

    const companyInfo = document.getElementById("companyInfo");
    const taskCreateForm = document.getElementById("taskCreateForm");
    const taskCreateMsg = document.getElementById("taskCreateMsg");
    const taskTitle = document.getElementById("taskTitle");
    const taskDescription = document.getElementById("taskDescription");
    const taskDifficulty = document.getElementById("taskDifficulty");
    const taskPrice = document.getElementById("taskPrice");

    function buildCurrentUserFromLogin(data, emailFromForm) {
      return {
        id: data.userId,
        role: data.role,
        fullName: data.fullName,
        email: emailFromForm
      };
    }

    function isCompanyLoggedIn() {
      return !!(
        authToken &&
        currentUser &&
        (currentUser.role === "COMPANY" || currentUser.role === "ROLE_COMPANY")
      );
    }

    function showEngineerPanel() {
      if (engineerPanel) engineerPanel.classList.remove("hidden");
      if (companyPanel) companyPanel.classList.add("hidden");
    }

    function updateCompanyPanel() {
      if (!companyPanel) return;

      if (isCompanyLoggedIn()) {
        if (companyInfo) companyInfo.classList.add("hidden");
        if (taskCreateForm) taskCreateForm.classList.remove("hidden");
      } else {
        if (companyInfo) companyInfo.classList.remove("hidden");
        if (taskCreateForm) taskCreateForm.classList.add("hidden");
      }
    }

    function showCompanyPanel() {
      if (engineerPanel) engineerPanel.classList.add("hidden");
      if (companyPanel) companyPanel.classList.remove("hidden");
      updateCompanyPanel();
    }

    function refreshAuthUI() {
      // Login/Register tab g√∂r√ºn√ºm√º
      if (authMode === "login") {
        tabLogin.classList.add("bg-slate-800");
        tabLogin.classList.remove("text-slate-300");
        tabRegister.classList.remove("bg-slate-800");
        tabRegister.classList.add("text-slate-300");
      } else {
        tabRegister.classList.add("bg-slate-800");
        tabRegister.classList.remove("text-slate-300");
        tabLogin.classList.remove("bg-slate-800");
        tabLogin.classList.add("text-slate-300");
      }

      // ƒ∞sim alanƒ±: sadece register modunda
      if (authMode === "register") {
        fullNameGroup.classList.remove("hidden");
      } else {
        fullNameGroup.classList.add("hidden");
      }

      // Buton metni / info
      if (appMode === "engineer") {
        if (authMode === "login") {
          authSubmitBtn.textContent = "Giri≈ü Yap";
          authInfo.innerHTML = 'Hesabƒ±n yok mu? Kayƒ±t olmak i√ßin √ºstteki sekmeden <strong>Kayƒ±t Ol</strong>‚Äôu se√ß.';
        } else {
          authSubmitBtn.textContent = "Kayƒ±t Ol";
          authInfo.innerHTML = "Zaten hesabƒ±n varsa √ºstteki sekmeden <strong>Giri≈ü</strong>e ge√ßebilirsin.";
        }
      } else { // company
        if (authMode === "login") {
          authSubmitBtn.textContent = "Firma Giri≈üi";
          authInfo.innerHTML = "Firma hesabƒ±nƒ±zla giri≈ü yapƒ±n; saƒü tarafta g√∂rev ekleme paneli a√ßƒ±lacak.";
        } else {
          authSubmitBtn.textContent = "Firma Kayƒ±t Ol";
          authInfo.innerHTML = "Firma hesabƒ± olu≈üturduktan sonra saƒü taraftan g√∂rev ekleyebilirsiniz.";
        }
      }
    }

    function switchAppMode(mode) {
      appMode = mode;
      authError.classList.add("hidden");
      registerSuccess.classList.add("hidden");
      authError.textContent = "";

      if (mode === "engineer") {
        modeEngineer.classList.add("bg-slate-800");
        modeEngineer.classList.remove("text-slate-300");
        modeCompany.classList.remove("bg-slate-800");
        modeCompany.classList.add("text-slate-300");
        engineerModeTabs.classList.remove("hidden");
        showEngineerPanel();
      } else {
        modeCompany.classList.add("bg-slate-800");
        modeCompany.classList.remove("text-slate-300");
        modeEngineer.classList.remove("bg-slate-800");
        modeEngineer.classList.add("text-slate-300");
        engineerModeTabs.classList.remove("hidden");
        showCompanyPanel();
      }

      refreshAuthUI();
    }

    function switchAuthMode(mode) {
      authMode = mode;
      authError.classList.add("hidden");
      registerSuccess.classList.add("hidden");
      authError.textContent = "";
      refreshAuthUI();
    }

    // Ba≈ülangƒ±√ß: engineer + login
    switchAppMode("engineer");
    switchAuthMode("login");

    // üëâ Profil (XP & Level) y√ºkleme
    async function loadProfile() {
      if (!authToken) return;
      try {
        const res = await fetch(API_BASE + "/api/profiles/me", {
          headers: {
            "Authorization": "Bearer " + authToken
          }
        });
        if (!res.ok) {
          throw new Error("Profil bilgileri alƒ±namadƒ±.");
        }
        const p = await res.json();
        if (typeof p.xpPoints === "number") {
          totalXp.textContent = p.xpPoints;
        } else {
          totalXp.textContent = "0";
        }
        if (typeof p.level === "number") {
          level.textContent = p.level;
        } else {
          level.textContent = "‚Äî";
        }
      } catch (err) {
        console.warn("Profil y√ºklenirken hata:", err);
        // Hata durumunda ekranƒ± resetlemeden sadece log basalƒ±m
      }
    }

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authError.classList.add("hidden");
      registerSuccess.classList.add("hidden");
      authError.textContent = "";

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const fullName = document.getElementById("fullName").value;

      try {
        // ---------- Fƒ∞RMA MODU ----------
        if (appMode === "company") {
          if (authMode === "login") {
            const res = await fetch(API_BASE + "/api/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password })
            });

            if (!res.ok) {
              throw new Error("Firma giri≈üi ba≈üarƒ±sƒ±z. Bilgileri kontrol edin.");
            }

            const data = await res.json();
            authToken = data.token || null;
            currentUser = buildCurrentUserFromLogin(data, email);

            userEmail.textContent = currentUser.email;
            userInfo.classList.remove("hidden");
            if (authCard) authCard.classList.add("hidden");
            showCompanyPanel();
            return;
          } else {
            const body = {
              email: email,
              password: password,
              fullName: fullName || null,
              role: "COMPANY"
            };

            const res = await fetch(API_BASE + "/api/auth/register", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body)
            });

            if (!res.ok) {
              let msg = "Kayƒ±t sƒ±rasƒ±nda bir hata olu≈ütu.";
              try {
                const errData = await res.json();
                if (errData && errData.message) msg = errData.message;
              } catch (_) {}
              throw new Error(msg);
            }

            const loginRes = await fetch(API_BASE + "/api/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password })
            });

            if (!loginRes.ok) {
              throw new Error("Kayƒ±t ba≈üarƒ±lƒ± ancak otomatik giri≈ü yapƒ±lamadƒ±, l√ºtfen manuel giri≈ü yapƒ±n.");
            }

            const loginData = await loginRes.json();
            authToken = loginData.token || null;
            currentUser = buildCurrentUserFromLogin(loginData, email);

            userEmail.textContent = currentUser.email;
            userInfo.classList.remove("hidden");
            if (authCard) authCard.classList.add("hidden");
            showCompanyPanel();
            return;
          }
        }

        // ---------- ENGINEER MODU ----------
        if (authMode === "login") {
          const res = await fetch(API_BASE + "/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password })
          });

          if (!res.ok) {
            throw new Error("Giri≈ü ba≈üarƒ±sƒ±z. Bilgileri kontrol edin.");
          }

          const data = await res.json();
          authToken = data.token || null;
          currentUser = buildCurrentUserFromLogin(data, email);

          userEmail.textContent = currentUser.email;
          userInfo.classList.remove("hidden");

          if (authCard) authCard.classList.add("hidden");
          showEngineerPanel();

          // üëâ Yeni: Giri≈üte profil + g√∂revleri y√ºkle
          await loadProfile();
          await loadTasks();
        } else {
          const body = {
            email: email,
            password: password,
            fullName: fullName || null,
            role: "ENGINEER"
          };

          const res = await fetch(API_BASE + "/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          if (!res.ok) {
            let msg = "Kayƒ±t sƒ±rasƒ±nda bir hata olu≈ütu.";
            try {
              const errData = await res.json();
              if (errData && errData.message) msg = errData.message;
            } catch (_) {}
            throw new Error(msg);
          }

          registerSuccess.classList.remove("hidden");
          switchAuthMode("login");
        }
      } catch (err) {
        console.error(err);
        authError.textContent = err.message || "Beklenmeyen bir hata olu≈ütu.";
        authError.classList.remove("hidden");
      }
    });

    async function loadTasks() {
      taskError.classList.add("hidden");
      taskList.innerHTML = '<p class="text-xs text-slate-400">G√∂revler y√ºkleniyor...</p>';

      try {
        const res = await fetch(API_BASE + "/api/tasks", {
          headers: authToken
            ? { "Authorization": "Bearer " + authToken }
            : {}
        });

        if (!res.ok) {
          throw new Error("G√∂revler y√ºklenemedi.");
        }

        const tasks = await res.json();
        taskCount.textContent = tasks.length + " g√∂rev";

        if (!tasks.length) {
          taskList.innerHTML = '<p class="text-xs text-slate-400">≈ûu an a√ßƒ±k g√∂rev bulunmuyor.</p>';
          return;
        }

        taskList.innerHTML = "";
        tasks.forEach((task) => {
          const div = document.createElement("div");
          div.className = "flex items-center justify-between bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2";

          const difficulty = task.difficulty || "-";
          const price = (task.price !== undefined && task.price !== null) ? task.price : "";
          const status = task.status || "";

          const isEngineer = currentUser &&
            (currentUser.role === "ENGINEER" || currentUser.role === "ROLE_ENGINEER");

          const claimedByMe = !!task.claimedByMe;
          const submittedByMe = !!task.submittedByMe;

          let actionHtml = "";

          if (isEngineer) {
            if (!claimedByMe) {
              // Hen√ºz almamƒ±≈ü ‚Üí G√∂revi Al
              actionHtml = `
                <button
                  class="text-xs px-3 py-1 rounded-full border border-yellow-400 text-yellow-300 hover:bg-yellow-400 hover:text-slate-900 transition"
                  onclick="claimTask('${task.id}')"
                >
                  G√∂revi Al
                </button>`;
            } else if (claimedByMe && !submittedByMe) {
              // Almƒ±≈ü ama submit etmemi≈ü ‚Üí Submit
              actionHtml = `
                <button
                  class="text-xs px-3 py-1 rounded-full border border-emerald-400 text-emerald-300 hover:bg-emerald-400 hover:text-slate-900 transition"
                  onclick="submitTaskWithPrompt('${task.id}')"
                >
                  Submit (√á√∂z√ºm G√∂nder)
                </button>`;
            } else if (submittedByMe) {
              // Submit etmi≈ü ‚Üí etiket
              actionHtml = `
                <span class="text-[10px] px-2 py-1 rounded-full border border-emerald-400 text-emerald-300">
                  Submit edildi ‚Ä¢ Onay bekliyor
                </span>`;
            }
          }

          div.innerHTML = `
            <div>
              <p class="font-medium text-sm">${task.title || "G√∂rev"}</p>
              <p class="text-xs text-slate-400">${task.description || ""}</p>
              <p class="text-xs text-slate-500 mt-1">
                Durum: <span class="text-slate-200">${status || "-"}</span>
              </p>
              <p class="text-xs text-slate-500">
                Zorluk: <span class="text-slate-200">${difficulty}</span>
                ${price !== "" ? ' ‚Ä¢ √ñd√ºl: <span class="text-yellow-300">' + price + '</span>' : ""}
              </p>
            </div>
            <div class="ml-3">
              ${actionHtml}
            </div>
          `;
          taskList.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        taskError.textContent = err.message || "G√∂rev listesi alƒ±nƒ±rken hata olu≈ütu.";
        taskError.classList.remove("hidden");
      }
    }

    // Junior: G√∂revi al
    async function claimTask(taskId) {
      if (!authToken) {
        alert("G√∂rev alabilmek i√ßin √∂nce giri≈ü yapmalƒ±sƒ±n.");
        return;
      }

      try {
        const res = await fetch(API_BASE + "/api/tasks/" + taskId + "/claim", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + authToken
          }
        });

        if (!res.ok) {
          let msg = "G√∂rev alƒ±namadƒ±.";
          try {
            const errData = await res.json();
            if (errData && errData.message) msg = errData.message;
          } catch (_) {}
          throw new Error(msg);
        }

        alert("G√∂rev ba≈üarƒ±yla √ºzerine alƒ±ndƒ±. Kartta ≈üimdi Submit butonu g√∂z√ºkecek.");
        await loadTasks();
      } catch (err) {
        console.error(err);
        alert(err.message || "G√∂rev alƒ±nƒ±rken bir hata olu≈ütu.");
      }
    }

    // Junior: G√∂revi submit et (prompt ile)
    async function submitTaskWithPrompt(taskId) {
      if (!authToken) {
        alert("Submit edebilmek i√ßin giri≈ü yapmalƒ±sƒ±n.");
        return;
      }

      const notes = prompt(
        "Bu g√∂rev i√ßin yaptƒ±ƒüƒ±n √ßalƒ±≈ümayƒ± kƒ±saca √∂zetle (log / notlar / yapƒ±lan adƒ±mlar):",
        ""
      );
      if (notes === null) return;

      const attachmentUrl = prompt(
        "ƒ∞stersen dok√ºman / repo / config linki ekle (bo≈ü bƒ±rakabilirsin):",
        ""
      );

      const body = {
        notes: notes,
        attachmentUrl: attachmentUrl || null
      };

      try {
        const res = await fetch(API_BASE + "/api/tasks/" + taskId + "/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + authToken
          },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          let msg = "G√∂rev submit edilemedi.";
          try {
            const errData = await res.json();
            if (errData && errData.message) msg = errData.message;
          } catch (_) {}
          throw new Error(msg);
        }

        alert("G√∂rev ba≈üarƒ±yla submit edildi. Mentor / firma onayƒ±ndan sonra XP kazanacaksƒ±n.");
        // Submit sonrasƒ± XP‚Äôyi de g√ºncelle
        await loadProfile();
        await loadTasks();
      } catch (err) {
        console.error(err);
        alert(err.message || "G√∂rev submit edilirken bir hata olu≈ütu.");
      }
    }

    // Firma task create: sadece COMPANY rol√º login ise
    if (taskCreateForm) {
      taskCreateForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        taskCreateMsg.classList.add("hidden");
        taskCreateMsg.textContent = "";

        if (!isCompanyLoggedIn()) {
          taskCreateMsg.textContent = "G√∂rev eklemek i√ßin √∂nce firma olarak giri≈ü yapmalƒ±sƒ±nƒ±z.";
          taskCreateMsg.classList.remove("hidden");
          taskCreateMsg.classList.remove("text-emerald-400");
          taskCreateMsg.classList.add("text-red-400");
          return;
        }

        const title = taskTitle.value.trim();
        const description = taskDescription.value.trim();
        const difficulty = taskDifficulty.value;
        const priceValue = parseFloat(taskPrice.value);

        if (!title || isNaN(priceValue)) {
          taskCreateMsg.textContent = "Ba≈ülƒ±k ve √∂d√ºl alanlarƒ± zorunludur.";
          taskCreateMsg.classList.remove("hidden");
          taskCreateMsg.classList.remove("text-emerald-400");
          taskCreateMsg.classList.add("text-red-400");
          return;
        }

        const body = {
          title: title,
          description: description,
          difficulty: difficulty,
          price: priceValue
        };

        try {
          const res = await fetch(API_BASE + "/api/tasks", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + authToken
            },
            body: JSON.stringify(body)
          });

          if (!res.ok) {
            let msg = "G√∂rev eklenemedi.";
            try {
              const errData = await res.json();
              if (errData && errData.message) msg = errData.message;
            } catch (_) {}
            throw new Error(msg);
          }

          taskTitle.value = "";
          taskDescription.value = "";
          taskDifficulty.value = "MEDIUM";
          taskPrice.value = "";

          taskCreateMsg.textContent = "G√∂rev ba≈üarƒ±yla eklendi.";
          taskCreateMsg.classList.remove("hidden");
          taskCreateMsg.classList.remove("text-red-400");
          taskCreateMsg.classList.add("text-emerald-400");
        } catch (err) {
          console.error(err);
          taskCreateMsg.textContent = err.message || "G√∂rev eklenirken bir hata olu≈ütu.";
          taskCreateMsg.classList.remove("hidden");
          taskCreateMsg.classList.remove("text-emerald-400");
          taskCreateMsg.classList.add("text-red-400");
        }
      });
    }

    function logout() {
      authToken = null;
      currentUser = null;
      userInfo.classList.add("hidden");

      if (authCard) authCard.classList.remove("hidden");
      showEngineerPanel(); // default g√∂r√ºn√ºm
      updateCompanyPanel();

      taskList.innerHTML = '<p class="text-slate-400 text-xs">Giri≈ü yaptƒ±ktan sonra a√ßƒ±k g√∂revler burada listelenecek.</p>';
      taskCount.textContent = "0 g√∂rev";
      totalXp.textContent = "0";
      level.textContent = "‚Äî";

      authForm.reset();
      switchAppMode("engineer");
      switchAuthMode("login");
    }
  </script>
</body>
</html>
