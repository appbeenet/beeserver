<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AppBee â€¢ Pilot Kanban</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --card:#16224a;
      --card2:#1a2a57;
      --text:#e8eeff;
      --muted:#a9b5e6;
      --line:#26345f;
      --accent:#f2c94c;
      --good:#2bd4a7;
      --warn:#ffcc66;
      --bad:#ff5d73;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --r:16px;
      --r2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(242,201,76,.16), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(43,212,167,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      background: rgba(11,16,32,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(38,52,95,.6);
    }
    .topbar{
      max-width: 1380px;
      margin:0 auto;
      padding:14px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 240px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(242,201,76,1), rgba(242,201,76,.45));
      box-shadow: 0 12px 28px rgba(242,201,76,.22);
      display:grid;place-items:center;
      font-weight:900; color:#1b2a49;
      letter-spacing:-.02em;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .brand small{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    .pill{
      background: rgba(17,26,51,.65);
      border:1px solid rgba(38,52,95,.7);
      padding:10px 12px;
      border-radius: 999px;
      display:flex; gap:10px; align-items:center;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .pill .k{ color:var(--muted); font-size:12px; }
    .pill .v{ font-weight:700; font-size:13px; }
    .pill .dot{ width:8px;height:8px;border-radius:999px; background: var(--accent); }
    .right{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .controls{
      max-width: 1380px;
      margin:0 auto;
      padding: 10px 16px 14px 16px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .controls .leftc, .controls .rightc{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    select, input[type="text"], button{
      background: rgba(17,26,51,.72);
      border:1px solid rgba(38,52,95,.8);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      outline:none;
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      font-size:13px;
    }
    button{
      cursor:pointer;
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
    }
    button:hover{ border-color: rgba(242,201,76,.85); }
    button:active{ transform: translateY(1px); }
    .btn-accent{
      background: rgba(242,201,76,.14);
      border-color: rgba(242,201,76,.65);
    }
    .btn-ghost{
      background: rgba(17,26,51,.45);
    }
    .prog{
      width: 260px;
      max-width: 52vw;
      height: 10px;
      border-radius: 999px;
      border:1px solid rgba(38,52,95,.85);
      background: rgba(17,26,51,.55);
      overflow:hidden;
    }
    .prog > div{
      height: 100%;
      width: 35%;
      background: linear-gradient(90deg, rgba(242,201,76,1), rgba(43,212,167,1));
    }
    .main{
      max-width: 1380px;
      margin: 0 auto;
      padding: 14px 16px 26px 16px;
    }

    .board{
      display:grid;
      grid-template-columns: repeat(6, minmax(240px, 1fr));
      gap:12px;
      overflow-x:auto;
      padding-bottom: 8px;
    }
    .col{
      background: rgba(17,26,51,.55);
      border:1px solid rgba(38,52,95,.7);
      border-radius: var(--r);
      min-height: 68vh;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
    }
    .colhead{
      padding: 12px 12px 10px 12px;
      border-bottom:1px solid rgba(38,52,95,.55);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .coltitle{
      display:flex;
      gap:8px;
      align-items:center;
      font-weight:800;
      letter-spacing:.2px;
      font-size:13px;
    }
    .count{
      font-size:12px;
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,48,.75);
      border:1px solid rgba(38,52,95,.6);
    }
    .dropzone{
      padding: 10px 10px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .dropzone.dragover{
      outline: 2px dashed rgba(242,201,76,.65);
      outline-offset: -8px;
      background: rgba(242,201,76,.06);
    }

    .card{
      background: linear-gradient(180deg, rgba(22,34,74,.95), rgba(15,23,48,.92));
      border:1px solid rgba(38,52,95,.7);
      border-radius: var(--r2);
      padding: 10px 10px 10px 10px;
      cursor: grab;
      user-select:none;
      box-shadow: 0 14px 30px rgba(0,0,0,.28);
      transition: transform .08s ease, border-color .2s ease;
    }
    .card:hover{ border-color: rgba(242,201,76,.55); }
    .card:active{ cursor: grabbing; transform: translateY(1px); }
    .cardtop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 6px;
    }
    .card h3{
      margin:0;
      font-size:13px;
      line-height:1.25;
      letter-spacing:.1px;
    }
    .meta{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-top: 6px;
    }
    .tag{
      font-size:11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(38,52,95,.75);
      background: rgba(11,16,32,.35);
      color: var(--muted);
      display:inline-flex; gap:6px; align-items:center;
    }
    .tag b{ color: var(--text); font-weight:800; }
    .prio{
      width:8px;height:8px;border-radius:999px;
      background: var(--warn);
    }
    .prio.good{ background: var(--good); }
    .prio.bad{ background: var(--bad); }
    .desc{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      margin-top: 6px;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .smallbtns{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 10px;
    }
    .smallbtns button{
      padding:8px 10px;
      border-radius: 10px;
      font-size:12px;
      box-shadow:none;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 20;
    }
    .modal.open{ display:flex; }
    .sheet{
      width: min(920px, 96vw);
      max-height: 92vh;
      overflow:auto;
      background: rgba(17,26,51,.92);
      border:1px solid rgba(38,52,95,.85);
      border-radius: 18px;
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding: 14px;
    }
    .sheethead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(38,52,95,.6);
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .sheet h2{ margin:0; font-size:16px; letter-spacing:.1px; }
    .sheet small{ color: var(--muted); }
    textarea{
      width:100%;
      min-height: 86px;
      resize: vertical;
      background: rgba(15,23,48,.7);
      border:1px solid rgba(38,52,95,.85);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.35;
      outline:none;
      font-family: var(--sans);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .grid1{ display:grid; gap:10px; }
    .lab{ color: var(--muted); font-size: 12px; margin: 0 0 6px 2px; }
    .mono{
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(11,16,32,.45);
      border:1px solid rgba(38,52,95,.8);
      border-radius: 14px;
      padding: 10px 12px;
      overflow:auto;
      white-space: pre-wrap;
      line-height:1.35;
    }
    .sheetfoot{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      margin-top: 10px;
      padding-top: 10px;
      border-top:1px solid rgba(38,52,95,.6);
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-right:auto;
    }

    /* Responsive */
    @media (max-width: 980px){
      .board{ grid-template-columns: repeat(6, minmax(280px, 1fr)); }
      .grid2{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">ğŸ</div>
      <div>
        <h1>AppBee â€¢ Pilot Kanban</h1>
        <small>AI + Kolektif Ãœretim â€¢ 14 GÃ¼n</small>
      </div>
    </div>

    <div class="right">
      <div class="pill" title="Program gÃ¼nÃ¼">
        <div class="dot"></div>
        <div>
          <div class="k">GÃ¼n</div>
          <div class="v" id="dayLabel">Day 1 / 14</div>
        </div>
      </div>
      <div class="pill" title="BugÃ¼nkÃ¼ rolÃ¼n">
        <div class="dot" style="background:var(--good)"></div>
        <div>
          <div class="k">Aktif Rol</div>
          <div class="v" id="roleLabel">Explorer ğŸŸ¡</div>
        </div>
      </div>
      <div class="pill" title="BugÃ¼n kazandÄ±ÄŸÄ±n XP">
        <div class="dot" style="background:var(--accent)"></div>
        <div>
          <div class="k">GÃ¼nlÃ¼k XP</div>
          <div class="v"><span id="xpLabel">+0</span> XP</div>
        </div>
      </div>
      <div class="pill" title="Ãœst Ã¼ste gÃ¼n sayÄ±sÄ±">
        <div class="dot" style="background:var(--warn)"></div>
        <div>
          <div class="k">Streak</div>
          <div class="v">ğŸ”¥ <span id="streakLabel">0</span> gÃ¼n</div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <div class="leftc">
      <label style="display:flex; gap:10px; align-items:center;">
        <span style="color:var(--muted); font-size:12px;">GÃ¼n seÃ§</span>
        <select id="daySelect"></select>
      </label>

      <label style="display:flex; gap:10px; align-items:center;">
        <span style="color:var(--muted); font-size:12px;">Ara</span>
        <input id="search" type="text" placeholder="kart baÅŸlÄ±ÄŸÄ± / tag / rol..." />
      </label>

      <button class="btn-ghost" id="resetBtn" title="Board'u sÄ±fÄ±rla">SÄ±fÄ±rla</button>
    </div>

    <div class="rightc">
      <div style="display:flex; gap:10px; align-items:center;">
        <span style="color:var(--muted); font-size:12px;">Seviye</span>
        <div class="prog" title="Junior â†’ Developing">
          <div id="levelBar"></div>
        </div>
        <span style="font-size:12px; color:var(--muted);" id="levelLabel">Junior â€¢ %35</span>
      </div>
      <button class="btn-accent" id="newCardBtn">+ Kart</button>
    </div>
  </div>
</header>

<main class="main">
  <div class="board" id="board"></div>
</main>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-label="Kart DetayÄ±">
    <div class="sheethead">
      <div>
        <h2 id="mTitle">Kart</h2>
        <small id="mMeta">Day â€¢ Column â€¢ Role</small>
      </div>
      <button class="btn-ghost" id="closeModal">Kapat</button>
    </div>

    <div class="grid2">
      <div class="grid1">
        <div>
          <div class="lab">AmaÃ§ (tek cÃ¼mle)</div>
          <textarea id="mGoal" placeholder="Bu kartÄ±n amacÄ±..."></textarea>
        </div>

        <div>
          <div class="lab">Teslim FormatÄ±</div>
          <textarea id="mDeliver" placeholder="Teslim formatÄ± / checklist..."></textarea>
        </div>

        <div>
          <div class="lab">Notlar</div>
          <textarea id="mNotes" placeholder="KÄ±sa notlar..."></textarea>
        </div>
      </div>

      <div class="grid1">
        <div>
          <div class="lab">AI Prompt (opsiyonel)</div>
          <textarea id="mPrompt" placeholder="AmaÃ§ / BaÄŸlam / KÄ±sÄ±t / Beklenen Ã§Ä±ktÄ± / Kriter..."></textarea>
          <div class="smallbtns">
            <button class="btn-ghost" id="copyPrompt">Prompt'u Kopyala</button>
            <button class="btn-accent" id="markDone">Done'a TaÅŸÄ±</button>
          </div>
        </div>

        <div>
          <div class="lab">AI Ã‡Ä±ktÄ±sÄ± / KanÄ±t (link, metin, ekran gÃ¶rÃ¼ntÃ¼sÃ¼)</div>
          <div class="mono" id="mProof">(buraya yapÄ±ÅŸtÄ±r)</div>
          <div class="smallbtns">
            <button class="btn-ghost" id="editProof">DÃ¼zenle</button>
            <button class="btn-ghost" id="copyProof">Kopyala</button>
          </div>
        </div>
      </div>
    </div>

    <div class="sheetfoot">
      <div class="hint" id="mHint">Ä°pucu: KartÄ± sÃ¼rÃ¼kleyip kolon deÄŸiÅŸtirebilirsin.</div>
      <button class="btn-ghost" id="deleteCard">Sil</button>
      <button class="btn-accent" id="saveCard">Kaydet</button>
    </div>
  </div>
</div>

<script>
  // ---------- Data model ----------
  const COLUMNS = [
    { id: "today",      title: "ğŸ“¥ Today",       icon:"ğŸ“¥" },
    { id: "withAI",     title: "ğŸ¤– With AI",     icon:"ğŸ¤–" },
    { id: "inProgress", title: "ğŸ§  In Progress", icon:"ğŸ§ " },
    { id: "review",     title: "ğŸ‘€ Review",      icon:"ğŸ‘€" },
    { id: "collective", title: "ğŸ¤ Collective",  icon:"ğŸ¤" },
    { id: "done",       title: "âœ… Done",        icon:"âœ…" },
  ];

  const DAY_ROLE = {
    1:"Explorer ğŸŸ¡", 2:"Explorer ğŸŸ¡", 3:"Builder ğŸ”µ", 4:"Architect ğŸŸ ", 5:"Reviewer ğŸŸ£", 6:"Builder ğŸ”µ", 7:"Integrator ğŸŸ¢",
    8:"Explorer ğŸŸ¡", 9:"Architect ğŸŸ ", 10:"Integrator ğŸŸ¢", 11:"Builder ğŸ”µ", 12:"Reviewer ğŸŸ£", 13:"Integrator ğŸŸ¢", 14:"Reviewer ğŸŸ£"
  };

  const DEFAULT_BY_DAY = {
    1: [
      mk("d1_t1","KiÅŸisel hedefini yaz", "Explorer ğŸŸ¡", "30 dk", ["Onboarding","Commitment"], "today",
         "14 gÃ¼nde neyi baÅŸarmak istiyorsun?"),
      mk("d1_t2","KurallarÄ± onayla", "Integrator ğŸŸ¢", "15 dk", ["Manifesto","Kurallar"], "today",
         "Manifesto / beklentiler / teminat koÅŸullarÄ±."),
    ],
    2: [
      mk("d2_t1","3 farklÄ± soru yaz", "Explorer ğŸŸ¡", "30 dk", ["AI","Framing"], "withAI",
         "AynÄ± problemi 3 farklÄ± ÅŸekilde sor."),
      mk("d2_t2","3 yaklaÅŸÄ±mÄ± kÄ±yasla", "Architect ğŸŸ ", "30 dk", ["AI","Alternatif"], "withAI",
         "AIâ€™den 3 Ã§Ã¶zÃ¼m al, hangisini neden seÃ§tin?"),
    ],
    3: [
      mk("d3_t1","Mini Ã§Ä±ktÄ± Ã¼ret", "Builder ğŸ”µ", "60 dk", ["Build","Output"], "today",
         "KÃ¼Ã§Ã¼k ama Ã§alÄ±ÅŸan bir Ã§Ä±ktÄ± Ã¼ret (script/UI/dokÃ¼man)."),
      mk("d3_t2","KanÄ±t ekle", "Builder ğŸ”µ", "10 dk", ["Proof"], "today",
         "Link / ekran gÃ¶rÃ¼ntÃ¼sÃ¼ / kÄ±sa aÃ§Ä±klama ekle."),
    ],
    4: [
      mk("d4_t1","AmaÃ§ / kapsam / kÄ±sÄ±t yaz", "Architect ğŸŸ ", "45 dk", ["Scope","Constraints"], "today",
         "Ã‡Ã¶zÃ¼mÃ¼n sÄ±nÄ±rlarÄ±nÄ± netleÅŸtir."),
      mk("d4_t2","Alternatifleri listele", "Explorer ğŸŸ¡", "25 dk", ["Trade-off"], "withAI",
         "3 alternatif yaklaÅŸÄ±m + artÄ±/eksi."),
    ],
    5: [
      mk("d5_t1","Peer review yap", "Reviewer ğŸŸ£", "45 dk", ["Review","Feedback"], "review",
         "ğŸ‘ GÃ¼Ã§lÃ¼ yÃ¶n / âš ï¸ Risk / ğŸ”§ Ä°yileÅŸtirme yaz."),
      mk("d5_t2","Risk senaryosu Ã§Ä±kar", "Reviewer ğŸŸ£", "30 dk", ["Risk","Edge-case"], "withAI",
         "Bu Ã§Ã¶zÃ¼m nerede patlar? 5 senaryo."),
    ],
    6: [
      mk("d6_t1","AI taslaÄŸÄ±nÄ± revize et", "Builder ğŸ”µ", "60 dk", ["Loop","Iteration"], "collective",
         "A tanÄ±mlar â†’ AI Ã¼retir â†’ sen revize edersin."),
      mk("d6_t2","Revizyon notu yaz", "Integrator ğŸŸ¢", "20 dk", ["Decision"], "collective",
         "Ne deÄŸiÅŸti, neden?"),
    ],
    7: [
      mk("d7_t1","HaftalÄ±k retrospektif", "Integrator ğŸŸ¢", "25 dk", ["Retro","Motivation"], "today",
         "Zorlayan / motive eden / devam isteÄŸi (1â€“10)."),
    ],
    8: [
      mk("d8_t1","Capstone problemi seÃ§", "Explorer ğŸŸ¡", "45 dk", ["Capstone","Ownership"], "collective",
         "Problem tanÄ±mÄ± + baÅŸarÄ± kriteri."),
    ],
    9: [
      mk("d9_t1","Rol daÄŸÄ±lÄ±mÄ± yap", "Integrator ğŸŸ¢", "20 dk", ["Roles"], "collective",
         "BugÃ¼nkÃ¼ rolÃ¼n + sorumluluÄŸun."),
      mk("d9_t2","PlanÄ± Ã§Ä±kar", "Architect ğŸŸ ", "40 dk", ["Plan"], "collective",
         "2 gÃ¼nlÃ¼k mini plan (bugÃ¼n/yarÄ±n)."),
    ],
    10: [
      mk("d10_t1","Karar notu (ADR) yaz", "Integrator ğŸŸ¢", "60 dk", ["ADR","Decision"], "collective",
         "Alternatifler, seÃ§ilen Ã§Ã¶zÃ¼m, riskler."),
    ],
    11: [
      mk("d11_t1","Iterasyon #1", "Builder ğŸ”µ", "60 dk", ["Iteration"], "inProgress",
         "Geri bildirim al, iyileÅŸtir."),
    ],
    12: [
      mk("d12_t1","Iterasyon #2", "Reviewer ğŸŸ£", "60 dk", ["Quality"], "review",
         "Kalite kontrol: test / edge-case / okunabilirlik."),
    ],
    13: [
      mk("d13_t1","Demo hazÄ±rlÄ±ÄŸÄ±", "Integrator ğŸŸ¢", "45 dk", ["Demo"], "today",
         "10 dk anlatÄ±m: problem â†’ yaklaÅŸÄ±m â†’ karar â†’ Ã¶ÄŸrenilenler."),
    ],
    14: [
      mk("d14_t1","Final retrospektif", "Reviewer ğŸŸ£", "30 dk", ["Retro"], "today",
         "Ne kattÄ±? 30 gÃ¼n devam eder misin? Neden?"),
    ]
  };

  function mk(id, title, role, eta, tags, column, goal){
    return {
      id, title, role, eta, tags,
      column, day: 1,
      goal: goal || "",
      deliver: "",
      notes: "",
      prompt: "",
      proof: ""
    };
  }

  // State persisted in localStorage
  const STORAGE_KEY = "appbee_pilot_kanban_v1";
  let state = loadState() || {
    currentDay: 1,
    streak: 0,
    xpToday: 0,
    levelPct: 35,
    cardsByDay: deepClone(DEFAULT_BY_DAY),
  };

  // Ensure every card has correct day
  for (let d=1; d<=14; d++){
    (state.cardsByDay[d] || []).forEach(c => c.day = d);
  }

  // ---------- UI init ----------
  const boardEl = document.getElementById("board");
  const daySelect = document.getElementById("daySelect");
  const dayLabel = document.getElementById("dayLabel");
  const roleLabel = document.getElementById("roleLabel");
  const xpLabel = document.getElementById("xpLabel");
  const streakLabel = document.getElementById("streakLabel");
  const levelBar = document.getElementById("levelBar");
  const levelLabel = document.getElementById("levelLabel");
  const searchEl = document.getElementById("search");

  const modal = document.getElementById("modal");
  const closeModalBtn = document.getElementById("closeModal");

  // Modal fields
  const mTitle = document.getElementById("mTitle");
  const mMeta  = document.getElementById("mMeta");
  const mGoal  = document.getElementById("mGoal");
  const mDeliver = document.getElementById("mDeliver");
  const mNotes = document.getElementById("mNotes");
  const mPrompt = document.getElementById("mPrompt");
  const mProof  = document.getElementById("mProof");
  const saveCardBtn = document.getElementById("saveCard");
  const deleteCardBtn = document.getElementById("deleteCard");
  const markDoneBtn = document.getElementById("markDone");
  const copyPromptBtn = document.getElementById("copyPrompt");
  const editProofBtn = document.getElementById("editProof");
  const copyProofBtn = document.getElementById("copyProof");

  const resetBtn = document.getElementById("resetBtn");
  const newCardBtn = document.getElementById("newCardBtn");

  let activeCardId = null;

  // Populate day select
  for (let i=1;i<=14;i++){
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Day ${i}`;
    daySelect.appendChild(opt);
  }

  daySelect.value = state.currentDay;

  // ---------- Render ----------
  function render(){
    const day = Number(state.currentDay);
    const query = (searchEl.value || "").trim().toLowerCase();

    // Top labels
    dayLabel.textContent = `Day ${day} / 14`;
    roleLabel.textContent = DAY_ROLE[day] || "â€”";
    xpLabel.textContent = (state.xpToday>=0?"+":"") + state.xpToday;
    streakLabel.textContent = state.streak;
    levelBar.style.width = `${clamp(state.levelPct,0,100)}%`;
    levelLabel.textContent = `Junior â€¢ %${clamp(state.levelPct,0,100)}`;

    // Columns
    boardEl.innerHTML = "";
    const cards = (state.cardsByDay[day] || []).filter(c => {
      if(!query) return true;
      const hay = [
        c.title, c.role, c.eta, (c.tags||[]).join(" "),
        c.goal, c.deliver, c.notes, c.prompt
      ].join(" ").toLowerCase();
      return hay.includes(query);
    });

    for(const col of COLUMNS){
      const colCards = cards.filter(c => c.column === col.id);
      const colEl = document.createElement("section");
      colEl.className = "col";
      colEl.dataset.col = col.id;

      colEl.innerHTML = `
        <div class="colhead">
          <div class="coltitle">${col.title}</div>
          <div class="count">${colCards.length}</div>
        </div>
        <div class="dropzone" data-dropzone="${col.id}"></div>
      `;

      const zone = colEl.querySelector(".dropzone");
      colCards.forEach(c => zone.appendChild(cardEl(c)));
      boardEl.appendChild(colEl);

      // drop events
      zone.addEventListener("dragover", (e)=>{ e.preventDefault(); zone.classList.add("dragover"); });
      zone.addEventListener("dragleave", ()=> zone.classList.remove("dragover"));
      zone.addEventListener("drop", (e)=>{
        e.preventDefault();
        zone.classList.remove("dragover");
        const id = e.dataTransfer.getData("text/plain");
        moveCardToColumn(id, col.id);
      });
    }

    saveState();
  }

  function cardEl(c){
    const el = document.createElement("div");
    el.className = "card";
    el.draggable = true;
    el.dataset.id = c.id;

    const prio = prioDot(c.tags);
    const tagHtml = (c.tags||[]).slice(0,4).map(t=> `<span class="tag"><span class="prio ${prio}"></span>${escapeHtml(t)}</span>`).join("");

    el.innerHTML = `
      <div class="cardtop">
        <h3>${escapeHtml(c.title)}</h3>
        <span class="tag" title="Tahmini sÃ¼re"><b>â±ï¸</b> ${escapeHtml(c.eta||"â€”")}</span>
      </div>
      <div class="meta">
        <span class="tag" title="Rol"><b>ğŸ</b> ${escapeHtml(c.role||"â€”")}</span>
        ${tagHtml}
      </div>
      <div class="desc">${escapeHtml(c.goal || "AmaÃ§ ekleâ€¦")}</div>
      <div class="smallbtns">
        <button class="btn-ghost" data-open="${c.id}">Detay</button>
        <button class="btn-accent" data-done="${c.id}">Done</button>
      </div>
    `;

    el.addEventListener("dragstart",(e)=>{
      e.dataTransfer.setData("text/plain", c.id);
      e.dataTransfer.effectAllowed = "move";
    });

    el.querySelector(`[data-open="${c.id}"]`).addEventListener("click", ()=> openModal(c.id));
    el.querySelector(`[data-done="${c.id}"]`).addEventListener("click", ()=> moveCardToColumn(c.id, "done", true));

    return el;
  }

  function prioDot(tags=[]){
    // very simple: if Risk tag -> bad, if Output/Done -> good else warn
    const s = (tags||[]).join(" ").toLowerCase();
    if(s.includes("risk") || s.includes("edge") || s.includes("retro")) return "bad";
    if(s.includes("output") || s.includes("demo") || s.includes("done") || s.includes("build")) return "good";
    return "";
  }

  // ---------- Actions ----------
  function getCardsOfDay(day){
    if(!state.cardsByDay[day]) state.cardsByDay[day] = [];
    return state.cardsByDay[day];
  }

  function findCard(day, id){
    return getCardsOfDay(day).find(c => c.id === id);
  }

  function moveCardToColumn(id, column, awardXP=false){
    const day = Number(state.currentDay);
    const c = findCard(day, id);
    if(!c) return;

    c.column = column;

    if(awardXP){
      const gained = xpFor(c, column);
      state.xpToday += gained;
      state.levelPct = clamp(state.levelPct + Math.round(gained/6), 0, 100);
      // simple streak logic: if any card moved to done today => streak+1 (once per day)
      if(!state._doneMarkedForDay || state._doneMarkedForDay !== day){
        state.streak += 1;
        state._doneMarkedForDay = day;
      }
    }

    render();
  }

  function xpFor(card, column){
    if(column !== "done") return 0;
    // Heuristic: review/collective gives more
    const base = 10;
    const bonusRole = (card.role||"").includes("Reviewer") ? 10 :
                      (card.role||"").includes("Integrator") ? 12 :
                      (card.role||"").includes("Architect") ? 8 : 6;
    const bonusCol = (card.column==="collective") ? 10 : 0; // not used after set
    const tagBonus = (card.tags||[]).some(t=> /review|risk|edge|adr/i.test(t)) ? 8 : 0;
    return base + bonusRole + tagBonus;
  }

  function openModal(id){
    const day = Number(state.currentDay);
    const c = findCard(day, id);
    if(!c) return;
    activeCardId = id;

    mTitle.textContent = c.title;
    mMeta.textContent  = `Day ${day} â€¢ ${colTitle(c.column)} â€¢ ${c.role}`;
    mGoal.value = c.goal || "";
    mDeliver.value = c.deliver || "";
    mNotes.value = c.notes || "";
    mPrompt.value = c.prompt || "";
    mProof.textContent = c.proof || "(buraya yapÄ±ÅŸtÄ±r)";

    modal.classList.add("open");
  }

  function closeModal(){
    modal.classList.remove("open");
    activeCardId = null;
  }

  function saveModal(){
    const day = Number(state.currentDay);
    const c = findCard(day, activeCardId);
    if(!c) return;
    c.goal = mGoal.value;
    c.deliver = mDeliver.value;
    c.notes = mNotes.value;
    c.prompt = mPrompt.value;
    // proof updated separately
    render();
    closeModal();
  }

  function deleteActiveCard(){
    const day = Number(state.currentDay);
    const arr = getCardsOfDay(day);
    const idx = arr.findIndex(x => x.id === activeCardId);
    if(idx>=0) arr.splice(idx,1);
    render();
    closeModal();
  }

  function colTitle(id){
    const c = COLUMNS.find(x=>x.id===id);
    return c ? c.title : id;
  }

  function addNewCard(){
    const day = Number(state.currentDay);
    const id = "u_" + Math.random().toString(16).slice(2,10);
    const c = mk(id, "Yeni task", DAY_ROLE[day] || "Explorer ğŸŸ¡", "30 dk", ["Custom"], "today", "AmaÃ§ ekleâ€¦");
    c.day = day;
    getCardsOfDay(day).unshift(c);
    render();
    openModal(id);
  }

  function resetAll(){
    if(!confirm("Board'u sÄ±fÄ±rlamak istiyor musun? (Kaydedilen ilerleme silinir)")) return;
    localStorage.removeItem(STORAGE_KEY);
    state = {
      currentDay: 1,
      streak: 0,
      xpToday: 0,
      levelPct: 35,
      cardsByDay: deepClone(DEFAULT_BY_DAY),
    };
    for (let d=1; d<=14; d++){
      (state.cardsByDay[d] || []).forEach(c => c.day = d);
    }
    daySelect.value = 1;
    render();
  }

  // Proof editing
  function editProof(){
    const val = prompt("AI Ã‡Ä±ktÄ±sÄ± / KanÄ±t (metin veya link):", mProof.textContent === "(buraya yapÄ±ÅŸtÄ±r)" ? "" : mProof.textContent);
    if(val === null) return;
    mProof.textContent = val.trim() || "(buraya yapÄ±ÅŸtÄ±r)";
    // persist in card
    const day = Number(state.currentDay);
    const c = findCard(day, activeCardId);
    if(c) c.proof = (mProof.textContent === "(buraya yapÄ±ÅŸtÄ±r)") ? "" : mProof.textContent;
    saveState();
  }

  // ---------- Events ----------
  daySelect.addEventListener("change", ()=>{
    state.currentDay = Number(daySelect.value);
    state.xpToday = 0; // pilot: reset daily xp on switch
    render();
  });

  searchEl.addEventListener("input", ()=> render());

  closeModalBtn.addEventListener("click", closeModal);
  modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });
  document.addEventListener("keydown",(e)=>{ if(e.key === "Escape") closeModal(); });

  saveCardBtn.addEventListener("click", saveModal);
  deleteCardBtn.addEventListener("click", deleteActiveCard);

  markDoneBtn.addEventListener("click", ()=>{
    if(!activeCardId) return;
    moveCardToColumn(activeCardId, "done", true);
    closeModal();
  });

  copyPromptBtn.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(mPrompt.value || "");
      toast("Prompt kopyalandÄ± âœ…");
    }catch{
      toast("Kopyalama baÅŸarÄ±sÄ±z (tarayÄ±cÄ± izinleri) âš ï¸");
    }
  });

  editProofBtn.addEventListener("click", editProof);

  copyProofBtn.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(mProof.textContent || "");
      toast("KanÄ±t kopyalandÄ± âœ…");
    }catch{
      toast("Kopyalama baÅŸarÄ±sÄ±z âš ï¸");
    }
  });

  resetBtn.addEventListener("click", resetAll);
  newCardBtn.addEventListener("click", addNewCard);

  // ---------- Helpers ----------
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
  }
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Tiny toast
  let toastTimer=null;
  function toast(msg){
    let t = document.getElementById("toast");
    if(!t){
      t = document.createElement("div");
      t.id="toast";
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="16px";
      t.style.transform="translateX(-50%)";
      t.style.background="rgba(17,26,51,.92)";
      t.style.border="1px solid rgba(38,52,95,.85)";
      t.style.color="var(--text)";
      t.style.padding="10px 12px";
      t.style.borderRadius="12px";
      t.style.boxShadow="0 18px 40px rgba(0,0,0,.45)";
      t.style.zIndex="50";
      t.style.fontSize="13px";
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.display="block";
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>{ t.style.display="none"; }, 1800);
  }

  // Initial render
  render();
</script>
</body>
</html>
